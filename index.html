<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Truck & Driver Scheduler</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0f0f0f;
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    h2, h3 {
      color: #ffffff;
      text-align: center;
      margin: 20px 0 10px;
    }

    .calendar-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px 30px;
      background-color: #1c1c1c;
      border-bottom: 1px solid #333;
      flex-wrap: wrap;
      gap: 10px;
    }

    .calendar-controls button {
      background-color: #333;
      color: #fff;
      border: 1px solid #444;
      border-radius: 5px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .calendar-controls button:hover {
      background-color: #444;
    }

    .calendar-container-wrapper {
      position: relative;
      max-width: 1350px;
      margin: 0 auto;
    }

    .calendar-container {
      display: grid;
      grid-template-columns: 1fr repeat(7, 1fr);
      width: 100%;
      border: 1px solid #333;
    }

    .column {
      background: #1a1a1a;
      padding: 10px;
      text-align: center;
      border: 1px solid #292929;
    }

    .column:hover {
      background: #222;
    }

    .fixed {
      position: sticky;
      left: 0;
      background: #202020;
      font-weight: bold;
      z-index: 2;
    }

    .truck-cell {
      height: 70px;
      position: relative;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .truck-cell:hover {
      background: #2a2a2a;
    }

    .entry-box {
      padding: 5px;
      border-radius: 5px;
      font-size: 13px;
      color: #fff;
      position: relative;
      height: 100%;
    }

    .entry-controls {
      display: none;
      position: absolute;
      bottom: 3px;
      right: 5px;
    }

    .entry-box:hover .entry-controls {
      display: block;
    }

    .week-nav-button {
      position: absolute;
      top: 40%;
      transform: translateY(-50%);
      background: #333;
      border: 1px solid #444;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: background 0.2s ease;
    }

    .week-nav-button:hover {
      background: #555;
    }

    #prevWeekBtn {
      left: -60px;
    }

    #nextWeekBtn {
      right: -60px;
    }

    .driver-list {
     display: grid;
     grid-template-columns: repeat(4, auto);
     gap: 15px 30px;
     padding: 20px;
     background: #1a1a1a;
     border-top: 1px solid #333;
     justify-content: center;
     position: relative;
    }

    .driver {
     background: #2d2d2d;
     padding: 8px 14px;
     border-radius: 8px;
     border: 2px solid #555;
     font-size: 14px;
     text-align: center;
     white-space: nowrap;

     display: flex;
     align-items: center;
     justify-content: center;
     height: 40px; 
    }


    .driver-status-available {
      border-color: #00c853;
    }

    .driver-status-driving {
      border-color: #ffd600;
    }

    .driver-status-break {
      border-color: #d50000;
    }

    .overlay-form,
    .driver-edit-form {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #555;
      width: 300px;
      z-index: 100;
      display: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.7);
    }

    .overlay-form label,
    .driver-edit-form label {
      display: block;
      margin-bottom: 5px;
      color: #ccc;
    }

    .overlay-form select,
    .overlay-form input,
    .driver-edit-form select {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      background: #292929;
      color: #fff;
      border: 1px solid #555;
      border-radius: 5px;
    }

    .overlay-form-buttons,
    .driver-edit-form-buttons {
      display: flex;
      justify-content: space-between;
    }

    .overlay-form-buttons button,
    .driver-edit-form button,
    #driver-edit-button {
      width: 48%;
      padding: 8px;
      background: #333;
      color: white;
      border: 1px solid #444;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .overlay-form-buttons button:hover,
    .driver-edit-form button:hover,
    #driver-edit-button:hover {
      background: #444;
    }

    #driver-edit-button {
      position: absolute;
      left: 10px;
      top: 10px;
      font-size: 13px;
      padding: 5px 10px;
      background: #333;
      color: white;
      border: 1px solid #444;
      border-radius: 4px;
      cursor: pointer;
      width: auto;
      height: auto;
      z-index: 5;
    }

    #driver-edit-button:hover {
      background: #444;
    }

    #clearWeekBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #444;
      color: white;
      border: 1px solid #666;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 22px;
      cursor: pointer;
      z-index: 50;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      transition: background 0.2s ease;
    }

    #clearWeekBtn:hover {
      background: #555;
    }
    
    #downloadReportBtn {
    position: fixed;
    bottom: 80px;
    right: 20px;
    background: #444;
    color: white;
    border: 1px solid #666;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    font-size: 20px;
    cursor: pointer;
    z-index: 50;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    transition: background 0.2s ease;
}

#downloadReportBtn:hover {
  background: #0099ff;
}
    .country-Австрия {background: #920000; }
    .country-Белгия {background: #0037a5; }
    .country-България {background: #017e0b; }
    .country-Хърватия {background: #ff1212; }
    .country-Чехия {background: #983eff; }
    .country-Дания {background: #07a6e6; }
    .country-Естония {background: #d35ccd; }
    .country-Финландия {background: #5f008b; }
    .country-Франция {background: #00b46f; }
    .country-Германия {background: #798605; }
    .country-Гърция {background: #d3e910; }
    .country-Унгария {background: #cc6504; }
    .country-Италия {background: #5cfc00; }
    .country-Латвия {background: #c23d74; }
    .country-Литва {background: #86005a; }
    .country-Нидерландия {background: #ff0000; }
    .country-Норвегия {background: #f08001; }
    .country-Полша {background: #437700; }
    .country-Португалия {background: #01c087; }
    .country-Румъния {background: #000283; }
    .country-Словакия {background: #970053; }
    .country-Словения {background: #e97f4e; }
    .country-Испания {background: #ddec0a; }
    .country-Швеция {background: #61b314; }
    .country-Швейцария {background: #148a45; }
    .country-Турция {background: #8a1515; }
   
  </style>
</head>
<body>

  <div class="calendar-controls">
    <h2 id="week-title">KarmelaTrans График</h2>
  </div>

  <div class="calendar-container-wrapper">
    <div id="prevWeekBtn" class="week-nav-button" onclick="prevWeek()">◀</div>

    <div class="calendar-container" id="calendar">
      <div class="column fixed">Камиони</div>
      <div class="column" id="day1"></div>
      <div class="column" id="day2"></div>
      <div class="column" id="day3"></div>
      <div class="column" id="day4"></div>
      <div class="column" id="day5"></div>
      <div class="column" id="day6"></div>
      <div class="column" id="day7"></div>

      <div class="column fixed truck-cell">BT0743MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>

      <div class="column fixed truck-cell">BT0744MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>

      <div class="column fixed truck-cell">BT0746MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>
    
      <div class="column fixed truck-cell">BT0747MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>

      <div class="column fixed truck-cell">BT0748MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>

      <div class="column fixed truck-cell">BT0750MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>
    
      <div class="column fixed truck-cell">BT0751MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>
    
      <div class="column fixed truck-cell">BT0752MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>
   
      <div class="column fixed truck-cell">BT0753MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>
   
      <div class="column fixed truck-cell">BT0754MB</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>
    
      <div class="column fixed truck-cell">ВТ1057МЕ</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>
    
      <div class="column fixed truck-cell">ВТ1059МЕ</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>

      <div class="column fixed truck-cell">ВТ1091МЕ</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>

      <div class="column fixed truck-cell">ВТ1092МЕ</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>

      <div class="column fixed truck-cell">ВТ1093МЕ</div>
      <div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div><div class="column truck-cell" onclick="openOverlay(this)"></div>
    </div>

    <div id="nextWeekBtn" class="week-nav-button" onclick="nextWeek()">▶</div>
  </div>

  <h3 style="text-align: center; margin-top: 20px;">Водачи</h3>
  <div class="driver-list">
    <button id="driver-edit-button" onclick="openDriverEditor()">✏️ Edit</button>
    <div class="driver" id="Антон Анков">Антон Анков</div>
    <div class="driver" id="Бойко Боянов">Бойко Боянов</div>
    <div class="driver" id="Боян Ангелов">Боян Ангелов</div>
    <div class="driver" id="Емилиян Михайлов">Емилиян Михайлов</div>
    <div class="driver" id="Ивайло Радоев">Ивайло Радоев</div>
    <div class="driver" id="Иван Георгиев">Иван Георгиев</div>
    <div class="driver" id="Иво Кирилов">Иво Кирилов</div>
    <div class="driver" id="Илиян Михайлов">Илиян Михайлов</div>
    <div class="driver" id="Красимир Костадинов">Красимир Костадинов</div>
    <div class="driver" id="Николай Кременски">Николай Кременски</div>
    <div class="driver" id="Петър Христов">Петър Христов</div>
    <div class="driver" id="Пламен Иванов">Пламен Иванов</div>
    <div class="driver" id="Тихомир Тодоров">Тихомир Тодоров</div>
    <div class="driver" id="Тони Денев">Тони Денев</div>
    <div class="driver" id="Цветомир Иванов">Цветомир Иванов</div>
    <div class="driver" id="Цветомир Цонев">Цветомир Цонев</div>
  </div>

  <div class="driver-edit-form" id="driverEditor">
    <label for="driverSelectEdit">Изберете водач:</label>
    <select id="driverSelectEdit">
      <option value="Антон Анков">Антон Анков</option>
      <option value="Бойко Боянов">Бойко Боянов</option>
      <option value="Боян Ангелов">Боян Ангелов</option>
      <option value="Емилиян Михайлов">Емилиян Михайлов</option>
      <option value="Ивайло Радоев">Ивайло Радоев</option>
      <option value="Иван Георгиев">Иван Георгиев</option>
      <option value="Иво Кирилов">Иво Кирилов</option>
      <option value="Илиян Михайлов">Илиян Михайлов</option>
      <option value="Красимир Костадинов">Красимир Костадинов</option>
      <option value="Николай Кременски">Николай Кременски</option>
      <option value="Петър Христов">Петър Христов</option>
      <option value="Пламен Иванов">Пламен Иванов</option>
      <option value="Тихомир Тодоров">Тихомир Тодоров</option>
      <option value="Тони Денев">Тони Денев</option>
      <option value="Цветомир Иванов">Цветомир Иванов</option>
      <option value="Цветомир Цонев">Цветомир Цонев</option>

    </select>
    <label for="driverStatusSelect">Статус:</label>
    <select id="driverStatusSelect">
      <option value="available">На разположение</option>
      <option value="driving">Шофира</option>
      <option value="break">Прави пауза</option>
    </select>
    <button onclick="saveDriverStatus()">Save</button>
    <button onclick="closeDriverEditor()">Cancel</button>
  </div>

  <div class="overlay-form" id="infoForm">
    <label>Водач:
      <select id="driverSelect">
        <option value="Антон Анков">Антон Анков</option>
      <option value="Бойко Боянов">Бойко Боянов</option>
      <option value="Боян Ангелов">Боян Ангелов</option>
      <option value="Емилиян Михайлов">Емилиян Михайлов</option>
      <option value="Ивайло Радоев">Ивайло Радоев</option>
      <option value="Иван Георгиев">Иван Георгиев</option>
      <option value="Иво Кирилов">Иво Кирилов</option>
      <option value="Илиян Михайлов">Илиян Михайлов</option>
      <option value="Красимир Костадинов">Красимир Костадинов</option>
      <option value="Николай Кременски">Николай Кременски</option>
      <option value="Петър Христов">Петър Христов</option>
      <option value="Пламен Иванов">Пламен Иванов</option>
      <option value="Тихомир Тодоров">Тихомир Тодоров</option>
      <option value="Тони Денев">Тони Денев</option>
      <option value="Цветомир Иванов">Цветомир Иванов</option>
      <option value="Цветомир Цонев">Цветомир Цонев</option>
      </select>
    </label>
    <label>От:
      <select id="fromCountry">
        <option value="Австрия">Австрия</option>
        <option value="Белгия">Белгия</option>
        <option value="България">България</option>
        <option value="Хърватия">Хърватия</option>
        <option value="Чехия">Чехия</option>
        <option value="Дания">Дания</option>
        <option value="Естония">Естония</option>
        <option value="Финландия">Финландия</option>
        <option value="Франция">Франция</option>
        <option value="Германия">Германия</option>
        <option value="Гърция">Гърция</option>
        <option value="Унгария">Унгария</option>
        <option value="Италия">Италия</option>
        <option value="Латвия">Латвия</option>
        <option value="Литва">Литва</option>
        <option value="Нидерландия">Нидерландия</option>
        <option value="Норвегия">Норвегия</option>
        <option value="Полша">Полша</option>
        <option value="Португалия">Португалия</option>
        <option value="Румъния">Румъния</option>
        <option value="Словакия">Словакия</option>
        <option value="Словения">Словения</option>
        <option value="Испания">Испания</option>
        <option value="Швеция">Швеция</option>
        <option value="Швейцария">Швейцария</option>
        <option value="Турция">Турция</option>

      </select>
    </label>
    <label>За:
      <select id="toCountry">
        <option value="Австрия">Австрия</option>
        <option value="Белгия">Белгия</option>
        <option value="България">България</option>
        <option value="Хърватия">Хърватия</option>
        <option value="Чехия">Чехия</option>
        <option value="Дания">Дания</option>
        <option value="Естония">Естония</option>
        <option value="Финландия">Финландия</option>
        <option value="Франция">Франция</option>
        <option value="Германия">Германия</option>
        <option value="Гърция">Гърция</option>
        <option value="Унгария">Унгария</option>
        <option value="Италия">Италия</option>
        <option value="Латвия">Латвия</option>
        <option value="Литва">Литва</option>
        <option value="Нидерландия">Нидерландия</option>
        <option value="Норвегия">Норвегия</option>
        <option value="Полша">Полша</option>
        <option value="Португалия">Португалия</option>
        <option value="Румъния">Румъния</option>
        <option value="Словакия">Словакия</option>
        <option value="Словения">Словения</option>
        <option value="Испания">Испания</option>
        <option value="Швеция">Швеция</option>
        <option value="Швейцария">Швейцария</option>
        <option value="Турция">Турция</option>
      </select>
    </label>
    <label>Начална дата: <input type="date" id="startDate"></label>
    <label>Крайна дата: <input type="date" id="endDate"></label>
    <div class="overlay-form-buttons">
      <button onclick="saveOverlay()">запази</button>
      <button onclick="closeOverlay()">отмени</button>
    </div>
  </div>

  <button id="clearWeekBtn" onclick="clearCurrentWeek()">🧹</button>
  <button id="downloadReportBtn" onclick="downloadReport()">🖨️</button>

  <script>
    let today = new Date();
    let dayOfWeek = today.getDay();
    let diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    let currentWeekStart = new Date(today);
    currentWeekStart.setDate(today.getDate() + diffToMonday);
    currentWeekStart.setHours(0, 0, 0, 0);
  
    let activeCell = null;
    let scheduledTasks = [];
    let driverStatuses = {};
    let longPauses = {};
  
    async function loadDataFromServer() {
      try {
        const res = await fetch('/api/load');
        const data = await res.json();
        scheduledTasks = data.tasks || [];
        driverStatuses = data.statuses || {};
        longPauses = data.longPauses || {};
        updateCalendar();
      } catch (e) {
        console.error("Failed to load data from server:", e);
      }
    }
  
    async function saveDataToServer() {
      try {
        await fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tasks: scheduledTasks,
            statuses: driverStatuses,
            longPauses: longPauses
          })
        });
      } catch (e) {
        console.error("Failed to save data to server:", e);
      }
    }
  
    function parseDateFromInput(dateStr) {
      const [year, month, day] = dateStr.split("-").map(Number);
      return new Date(year, month - 1, day);
    }
  
    function isDriverInLongPause(driver) {
      const pause = longPauses[driver];
      if (!pause) return false;
      const now = new Date();
      return now < new Date(pause);
    }
  
    function updateCalendar() {
      const options = { weekday: 'long', month: 'long', day: 'numeric' };
      for (let i = 0; i < 7; i++) {
        let date = new Date(currentWeekStart);
        date.setDate(currentWeekStart.getDate() + i);
        document.getElementById(`day${i + 1}`).innerText = date.toLocaleDateString('bg-BG', options);
      }
  
      const allCells = Array.from(document.querySelectorAll(".truck-cell:not(.fixed)"));
      allCells.forEach(cell => cell.innerHTML = "");
  
      const currentDrivers = new Set();
  
      for (let task of scheduledTasks) {
        const start = parseDateFromInput(task.startDate);
        const end = parseDateFromInput(task.endDate);
  
        let d = new Date(start);
        d.setHours(0, 0, 0, 0);
  
        while (d <= end) {
          const offset = Math.round((d - currentWeekStart) / (1000 * 60 * 60 * 24));
          if (offset >= 0 && offset < 7) {
            const cellIndex = task.truckRow * 7 + offset;
            const cell = allCells[cellIndex];
            if (cell) {
              cell.innerHTML = `
                <div class="entry-box country-${task.from}" data-task-id="${task.id}">
                  ${task.driver}<br>${task.from} → ${task.to}
                  <div class="entry-controls">
                    <button onclick="openOverlay(this.closest('.truck-cell'))">✏️</button>
                    <button onclick="removeTask('${task.id}')">❌</button>
                  </div>
                </div>`;
            }
            currentDrivers.add(task.driver);
          }
          d.setDate(d.getDate() + 1);
        }
      }
  
      for (let driver in driverStatuses) {
        if (driverStatuses[driver] === "driving" && !currentDrivers.has(driver)) {
          driverStatuses[driver] = "available";
        }
      }
  
      document.querySelectorAll('.driver').forEach(driver => {
        const name = driver.textContent.trim();
        driver.classList.remove("driver-status-available", "driver-status-driving", "driver-status-break");
        driver.style.opacity = "1";
  
        if (isDriverInLongPause(name)) {
          driver.classList.add("driver-status-break");
          driver.style.opacity = "0.4";
          driver.title = "На дълга пауза до " + new Date(longPauses[name]).toLocaleString('bg-BG');
        } else {
          const status = driverStatuses[name];
          if (status === "break") {
            driver.classList.add("driver-status-break");
          } else if (currentDrivers.has(name)) {
            driver.classList.add("driver-status-driving");
          } else {
            driver.classList.add("driver-status-available");
          }
          driver.removeAttribute("title");
        }
      });
  
      saveDataToServer();
    }
  
    function openOverlay(cell) {
      if (cell.classList.contains('fixed')) return;
      activeCell = cell;
      document.getElementById('infoForm').style.display = 'block';
    }
  
    function closeOverlay() {
      document.getElementById('infoForm').style.display = 'none';
      activeCell = null;
    }
  
    function saveOverlay() {
      if (!activeCell) return;
      const driver = document.getElementById('driverSelect').value;
      if (isDriverInLongPause(driver)) {
        alert("Този водач е в 45-часова пауза.");
        return;
      }
  
      const from = document.getElementById('fromCountry').value;
      const to = document.getElementById('toCountry').value;
      const startInput = document.getElementById('startDate').value;
      const endInput = document.getElementById('endDate').value;
      if (!startInput || !endInput) return;
  
      const index = Array.from(document.querySelectorAll(".truck-cell:not(.fixed)")).indexOf(activeCell);
      const row = Math.floor(index / 7);
  
      const taskId = `task-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
      scheduledTasks.push({
        id: taskId,
        driver, from, to,
        startDate: startInput,
        endDate: endInput,
        truckRow: row
      });
  
      closeOverlay();
      updateCalendar();
    }
  
    function removeTask(id) {
      if (!confirm("Сигурни ли сте, че искате да изтриете този курс?")) return;
      scheduledTasks = scheduledTasks.filter(t => t.id !== id);
      updateCalendar();
    }
  
    function clearCurrentWeek() {
      if (!confirm("Наистина ли искате да изтриете всичко за седмицата?")) return;
      const weekStart = new Date(currentWeekStart);
      const weekEnd = new Date(currentWeekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
  
      scheduledTasks = scheduledTasks.filter(task => {
        const start = parseDateFromInput(task.startDate);
        const end = parseDateFromInput(task.endDate);
        return end < weekStart || start > weekEnd;
      });
  
      updateCalendar();
    }
  
    function openDriverEditor() {
      document.getElementById("driverEditor").style.display = "block";
    }
  
    function closeDriverEditor() {
      document.getElementById("driverEditor").style.display = "none";
    }
  
    function saveDriverStatus() {
      const name = document.getElementById("driverSelectEdit").value;
      const status = document.getElementById("driverStatusSelect").value;
  
      if (status === "longpause") {
        const pauseStartInput = document.getElementById("longPauseStart");
        if (pauseStartInput && pauseStartInput.value) {
          const startTime = new Date(pauseStartInput.value);
          const pauseUntil = new Date(startTime.getTime() + 45 * 60 * 60 * 1000);
          longPauses[name] = pauseUntil.toISOString();
        } else {
          alert("Моля, въведете началото на 45-часовата пауза.");
          return;
        }
      } else {
        delete longPauses[name];
      }
  
      driverStatuses[name] = status;
      closeDriverEditor();
      updateCalendar();
    }
  
    function prevWeek() {
      currentWeekStart.setDate(currentWeekStart.getDate() - 7);
      updateCalendar();
    }
  
    function nextWeek() {
      currentWeekStart.setDate(currentWeekStart.getDate() + 7);
      updateCalendar();
    }
  
    function downloadReport() {
      let reportWindow = window.open("", "Report", "width=800,height=600");
      reportWindow.document.write("<html><head><title>Седмичен отчет</title>");
      reportWindow.document.write("<style>body { font-family: Arial; padding: 20px; }</style>");
      reportWindow.document.write("</head><body>");
      reportWindow.document.write(`<h2>Седмичен отчет (${currentWeekStart.toLocaleDateString('bg-BG')})</h2>`);
  
      if (scheduledTasks.length === 0) {
        reportWindow.document.write("<p>Няма предвидени и/или изпълнени курсове за тази седмица.</p>");
      } else {
        reportWindow.document.write("<ul>");
        for (let task of scheduledTasks) {
          const start = parseDateFromInput(task.startDate);
          const end = parseDateFromInput(task.endDate);
          const startStr = start.toLocaleDateString('bg-BG');
          const endStr = end.toLocaleDateString('bg-BG');
          reportWindow.document.write(
            `<li><strong>${task.driver}</strong>: ${task.from} → ${task.to} (${startStr} до ${endStr})</li>`
          );
        }
        reportWindow.document.write("</ul>");
      }
  
      reportWindow.document.write("</body></html>");
      reportWindow.document.close();
      reportWindow.print();
    }
  
    document.getElementById("driverStatusSelect").addEventListener("change", function () {
      const longPauseGroup = document.getElementById("longPauseStartGroup");
      if (this.value === "longpause") {
        longPauseGroup.style.display = "block";
      } else {
        longPauseGroup.style.display = "none";
      }
    });
  
    loadDataFromServer();
  </script>
  
</body>
</html>
  
